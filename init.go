package hls

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io"
	"os"
	"strings"
)

func js(v any) string {
	data, _ := json.Marshal(v)
	return string(data)
}

func writeplaylist(m Media, w io.Writer) error {
	init := ""
	m.File = append([]File{}, m.File...)
	for i := 0; i < len(m.File); i++ {
		f := &m.File[i]
		if init == f.Map.URI && !f.Discontinuous {
			f.Map.URI = ""
		} else {
			init = f.Map.URI
		}
	}
	tags, _ := m.EncodeTag()
	for _, t := range tags {
		fmt.Fprintln(w, t)
	}
	return nil
}

func init() {
	m0 := Master{}
	m0.Decode(strings.NewReader(sampleMaster))
	m1 := Media{}
	m1.Decode(strings.NewReader(sampleMedia))
	m2 := Media{}
	m2.Decode(strings.NewReader(sampleFrag))
	m3 := Media{}
	m3.Decode(strings.NewReader(sampleCue))
	b := new(bytes.Buffer)
	writeplaylist(m3, b)
	io.Copy(os.Stderr, b)
}

var sampleMedia = `
	#EXTM3U
	#EXT-X-VERSION:3
	#EXT-X-INDEPENDENT-SEGMENTS
	#EXT-X-PLAYLIST-TYPE:EVENT
	#EXT-X-START:TIME-OFFSET=25,PRECISE=YES
	#EXT-X-TARGETDURATION:10
	#EXT-X-MEDIA-SEQUENCE:1
	#EXT-X-DISCONTINUITY-SEQUENCE:2
	#EXTINF:10.0,
	ad0.ts
	#EXTINF:8.0,
	ad1.ts?m=142
	#EXT-X-DISCONTINUITY
	#EXT-X-PROGRAM-DATE-TIME:2021-01-11T07:59:41.005Z
	#EXTINF:10.0,
	movieA.ts
	#EXTINF:10.0,
	movieB.ts
	#EXT-X-ENDLIST
`
var sampleMaster = `
	#EXTM3U
	#EXT-X-VERSION:3
	#EXT-X-INDEPENDENT-SEGMENTS
	#EXT-X-STREAM-INF:BANDWIDTH=1111,AVERAGE-BANDWIDTH=1000,RESOLUTION=1x1,FRAME-RATE=29.970,CODECS="avc1.4D401F,mp4a.40.2"
	m1.m3u8
	#EXT-X-STREAM-INF:BANDWIDTH=2222,AVERAGE-BANDWIDTH=2000,RESOLUTION=2x2,FRAME-RATE=29.970,CODECS="avc1.4D401F,mp4a.40.2"
	m2.m3u8
	#EXT-X-STREAM-INF:BANDWIDTH=3333,AVERAGE-BANDWIDTH=3000,RESOLUTION=3x3,FRAME-RATE=29.970,CODECS="avc1.4D401F,mp4a.40.2"
	m3.m3u8
	#EXT-X-STREAM-INF:BANDWIDTH=4444,AVERAGE-BANDWIDTH=4000,RESOLUTION=4x4,FRAME-RATE=29.970,CODECS="avc1.4D401E,mp4a.40.2"
	m4.m3u8
	#EXT-X-STREAM-INF:BANDWIDTH=5555,AVERAGE-BANDWIDTH=5000,RESOLUTION=5x5,FRAME-RATE=29.970,CODECS="avc1.4D401E,mp4a.40.2"
	m5.m3u8
	#EXT-X-STREAM-INF:BANDWIDTH=6666,AVERAGE-BANDWIDTH=6000,RESOLUTION=6x6,FRAME-RATE=29.970,CODECS="avc1.4D400D,mp4a.40.2"
	m6.m3u8
	`

var sampleFrag = `
#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-PLAYLIST-TYPE:VOD
#EXT-X-MAP:URI="init.mp4"
#EXTINF:6.000000,
0.m4s
#EXTINF:6.000000,
1.m4s
#EXTINF:6.000000,
2.m4s
#EXTINF:6.000000,
3.m4s
#EXTINF:6.000000,
4.m4s
#EXTINF:6.000000,
5.m4s
#EXTINF:6.000000,
6.m4s
#EXTINF:6.000000,
7.m4s
#EXTINF:4.208333,
8.m4s
#EXT-X-ENDLIST
`

var sampleCue = `
#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-PLAYLIST-TYPE:EVENT
#EXT-X-MAP:URI="init.mp4"
#EXTINF:6.000000,
0.m4s
#EXTINF:6.000000,
1.m4s
#EXTINF:6.000000,
2.m4s
#EXT-OATCLS-SCTE35:/DAlAAAAAyiYAP/wFAUAAIMRf+/+0bb+Av4AUmNiAAEBAQAAM5uUog==
#EXT-X-CUE-OUT:DURATION=120,BREAKID=blahblahblah
#EXTINF:6.000000,
3.m4s
#EXT-X-CUE-OUT-CONT:DURATION=120,ELAPSEDTIME=6,SCTE35=/DAlAAAAAyiYAP/wFAUAAIMRf+/+0bb+Av4AUmNiAAEBAQAAM5uUog==
#EXTINF:6.000000,
4.m4s
#EXT-X-CUE-CONT:18
#EXTINF:6.000000,
5.m4s
#EXT-X-ASSET:CONTENT_ID="2447371",CONTENT_FREQID="4312662727378189181",CONTENT_EXTID="ABC12345-oo0021-h4c3d",CONTENT_LEN=3600,CONTENT_BRAND="Publisher%20ABC",CONTENT_GENRE="Entertainment",CONTENT_RATING="TV14",CONTENT_LANGUAGE="en",CONTENT_KEYWORDS="key1,word2,%20cool",CONTENT_TITLE="Best%20Fails%20of%20the%20Month%20|EP%20203",CONTENT_FORMAT="Show",CONTENT_SERIES="Best%20Fails%20of%20the%20Month",CONTENT_SEASON="Season%202",CONTENT_EPISODE=3,CONTENT_CONTEXT=1,CONTENT_PRODQ=1
#EXT-X-PLACEMENT-OPPORTUNITY
#EXT-X-CUE-IN
#EXTINF:6.000000,
6.m4s
#EXTINF:6.000000,
7.m4s
#EXT-X-CUE-IN
#EXTINF:4.208333,
8.m4s
#EXT-X-ENDLIST
`
